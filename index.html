<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>历史研究数据库</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <style>
        body { 
            font-family: 'Segoe UI', sans-serif; 
            margin: 0; 
            padding: 20px; 
            background: linear-gradient(135deg, #FFE4B5 0%, #FFB6C1 100%);
            min-height: 100vh;
            color: #333;
        }

        /* 按钮基础样式 */
        button {
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        /* 主按钮 */
        .btn-primary {
            background: #E6A35C;
            color: #FFFFFF;
            border: 2px solid #E6A35C;
        }

        .btn-primary:hover {
            background: #D47A43;
            border: 3px solid #D47A43;
        }

        .btn-primary:active {
            background: #B3743C;
            border: 3px solid #B3743C;
        }

        /* 删除按钮 */
        .btn-danger {
            background: #D32F2F;
            color: #FFFFFF;
            border: 2px solid #D32F2F;
        }

        .btn-danger:hover {
            background: #D32F2F;
            border: 3px solid #C2185B;
        }

        .btn-danger:active {
            background: #B71C1C;
            border: 3px solid #B71C1C;
        }

        /* 取消按钮 */
        .btn-cancel {
            background: #6D4C41;
            color: #FFFFFF;
            border: 2px solid #6D4C41;
        }

        .btn-cancel:hover {
            background: #5D4037;
            border: 3px solid #5D4037;
        }

        .btn-cancel:active {
            background: #4E342E;
            border: 3px solid #4E342E;
        }

        /* 文本按钮 */
        .btn-text {
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            border: 2px solid rgba(255, 255, 255, 0.9);
        }

        .btn-text:hover {
            background: rgba(255, 255, 255, 1);
            border: 3px solid rgba(255, 255, 255, 1);
        }

        .btn-text:active {
            background: rgba(255, 255, 255, 0.8);
            border: 3px solid rgba(255, 255, 255, 0.8);
        }

        #authContainer { 
            max-width: 400px; 
            margin: 50px auto; 
            padding: 30px; 
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .auth-form { 
            display: flex; 
            flex-direction: column; 
            gap: 15px; 
        }

        input { 
            padding: 12px; 
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 8px; 
            font-size: 14px;
            color: #333;
        }

        input::placeholder {
            color: rgba(0, 0, 0, 0.5);
        }

        .hidden { display: none; }

        #userBar { 
            position: fixed; 
            top: 0; 
            right: 20px; 
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            padding: 10px 20px; 
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border-radius: 0 0 15px 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        #contentContainer { 
            max-width: 1200px; 
            margin: 60px auto 20px; 
        }

        .project-table { 
            width: 100%; 
            border-collapse: collapse; 
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .project-table th, .project-table td { 
            padding: 15px; 
            text-align: left; 
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            color: #333;
        }

        .project-table th {
            background: rgba(255, 255, 255, 0.9);
            font-weight: 600;
        }

        .pagination { 
            margin-top: 20px; 
            display: flex; 
            gap: 10px; 
            align-items: center;
            color: #333;
        }

        h1, h2 {
            color: #333;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        a {
            color: #333;
            text-decoration: none;
            transition: color 0.3s ease;
        }

        a:hover {
            color: #000;
        }

        #searchInput {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(0, 0, 0, 0.1);
            color: #333;
        }

        #searchInput::placeholder {
            color: rgba(0, 0, 0, 0.5);
        }
    </style>
</head>
<body>

    <!-- 用户状态栏 -->
    <div id="userBar" class="hidden">
        <span id="userEmail" style="margin-right:15px"></span>
        <button onclick="signOut()" style="background:#dc3545">退出系统</button>
    </div>

    <!-- 认证模块 -->
    <div id="authContainer">
        <h2 style="text-align:center; margin-bottom:25px; color:#333">研究数据库登录</h2>
        <div class="auth-form">
            <input type="email" id="emailInput" placeholder="电子邮箱" required>
            <input type="password" id="passwordInput" placeholder="密码" required>
            <button onclick="handleLogin()" class="btn-primary">立即登录</button>
            <button onclick="handleSignUp()" class="btn-text">注册新账户</button>
            <div style="text-align:center; margin-top:15px;">
                <a href="#" onclick="sendPasswordReset()" style="color:#666; font-size:13px">忘记密码？</a>
            </div>
        </div>
    </div>

    <!-- 主内容容器 -->
    <div id="contentContainer" class="hidden">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:25px;">
            <h1 style="margin:0">研究项目管理</h1>
            <button onclick="createProject()" class="btn-primary">+ 新建项目</button>
        </div>
        <div style="margin-bottom:20px; display:flex; gap:10px">
            <input type="text" id="searchInput" placeholder="搜索项目名称" style="flex:1; max-width:300px">
            <button onclick="applyFilter()" class="btn-text">筛选</button>
            <button onclick="resetFilter()" class="btn-cancel">重置</button>
            <button onclick="syncFirebaseData()" class="btn-text">同步数据</button>
        </div>
        <div id="projectList"></div>
    </div>

    <script>
        // 初始化Firebase配置
        const firebaseConfig = {
            apiKey: "AIzaSyC5zQ6We55GvT8xexlQOLPpoTZip9Xac9k",
            authDomain: "slsj-54760.firebaseapp.com",
            databaseURL: "https://slsj-54760-default-rtdb.firebaseio.com",
            projectId: "slsj-54760",
            storageBucket: "slsj-54760.firebasestorage.app",
            messagingSenderId: "890890573955",
            appId: "1:890890573955:web:328c0ed09af23d634b23b6"
        };

        // 初始化Firebase服务
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();

        // 全局变量
        let projects = [];
        let currentPage = 1;
        const itemsPerPage = 10;
        let currentFilter = '';

        /*********************
         * 用户认证管理系统
         *********************/
        auth.onAuthStateChanged(user => {
            const contentContainer = document.getElementById('contentContainer');
            const authContainer = document.getElementById('authContainer');
            const userBar = document.getElementById('userBar');

            if (user) {
                userBar.classList.remove('hidden');
                contentContainer.classList.remove('hidden');
                authContainer.classList.add('hidden');
                document.getElementById('userEmail').textContent = user.email;
                loadProjects();
                db.ref(`users/${user.uid}/profile/lastLogin`).set(firebase.database.ServerValue.TIMESTAMP);
            } else {
                userBar.classList.add('hidden');
                contentContainer.classList.add('hidden');
                authContainer.classList.remove('hidden');
            }
        });

        async function handleLogin() {
            const email = document.getElementById('emailInput').value;
            const password = document.getElementById('passwordInput').value;
            try {
                await auth.signInWithEmailAndPassword(email, password);
            } catch (error) {
                handleAuthError(error);
            }
        }

        async function handleSignUp() {
            const email = document.getElementById('emailInput').value;
            const password = document.getElementById('passwordInput').value;
            try {
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                await db.ref(`users/${userCredential.user.uid}/profile`).set({
                    email: email,
                    createdAt: firebase.database.ServerValue.TIMESTAMP,
                    lastLogin: firebase.database.ServerValue.TIMESTAMP
                });
                alert('注册成功！已自动登录');
            } catch (error) {
                handleAuthError(error);
            }
        }

       
        function signOut() {
            auth.signOut();
            alert('已安全退出系统');
        }

        function handleAuthError(error) {
            const errorMap = {
                'auth/invalid-email': '邮箱格式不正确',
                'auth/user-disabled': '账户已被禁用',
                'auth/user-not-found': '该邮箱未注册',
                'auth/wrong-password': '密码错误',
                'auth/email-already-in-use': '邮箱已被注册',
                'auth/operation-not-allowed': '操作不被允许',
                'auth/weak-password': '密码需至少6位'
            };
            alert(errorMap[error.code] || `登录失败: ${error.message}`);
        }

        /*********************
         * 项目管理系统
         *********************/
        function getUserPath(path = '') {
            const user = auth.currentUser;
            if (!user) throw new Error('用户未登录');
            return `users/${user.uid}/${path}`;
        }

        function loadProjects() {
            db.ref(getUserPath('projects')).on('value', (snapshot) => {
                projects = snapshot.val() ? Object.values(snapshot.val()) : [];
                renderProjects();
            });
        }

        async function createProject() {
            const projectName = prompt('请输入新项目名称：');
            if (!projectName) return;
            try {
                const newProject = {
                    id: db.ref().push().key,
                    name: projectName,
                    createdAt: firebase.database.ServerValue.TIMESTAMP,
                    updatedAt: firebase.database.ServerValue.TIMESTAMP,
                    createdBy: auth.currentUser.uid
                };
                await db.ref(getUserPath(`projects/${newProject.id}`)).set(newProject);
                alert('项目创建成功！');
            } catch (error) {
                alert('创建失败: ' + error.message);
            }
        }

        function renderProjects() {
            const projectList = document.getElementById('projectList');
            projectList.innerHTML = '';
            
            const filteredProjects = projects.filter(p => 
                p.name.toLowerCase().includes(currentFilter.toLowerCase())
            );
            
            const totalPages = Math.ceil(filteredProjects.length / itemsPerPage);
            const paginatedProjects = filteredProjects.slice(
                (currentPage - 1) * itemsPerPage,
                currentPage * itemsPerPage
            );

            const table = document.createElement('table');
            table.className = 'project-table';
            table.innerHTML = `
                <thead>
                    <tr>
                        <th>项目名称</th>
                        <th style="width:180px">创建时间</th>
                        <th style="width:150px">操作</th>
                    </tr>
                </thead>
                <tbody>
                    ${paginatedProjects.map(project => `
                        <tr>
<td>
  <a href="javascript:void(0)" 
     onclick="navigateToDatabase('${project.id}')" 
     style="color: var(--primary-color); text-decoration: underline; cursor: pointer">
    ${project.name}
  </a>
</td>
                            <td>${new Date(project.createdAt).toLocaleString()}</td>
                            <td>
                                <button onclick="editProject('${project.id}')">编辑</button>
                                <button onclick="deleteProject('${project.id}')" style="background:#dc3545">删除</button>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            `;

            const pagination = document.createElement('div');
            pagination.className = 'pagination';
            pagination.innerHTML = `
                <button ${currentPage === 1 ? 'disabled' : ''} onclick="changePage(-1)">上一页</button>
                <span>第 ${currentPage} 页 / 共 ${totalPages} 页</span>
                <button ${currentPage >= totalPages ? 'disabled' : ''} onclick="changePage(1)">下一页</button>
            `;

            projectList.append(table, pagination);
        }

        async function editProject(projectId) {
            try {
                const projectRef = db.ref(getUserPath(`projects/${projectId}`));
                const snapshot = await projectRef.once('value');
                const project = snapshot.val();
                const newName = prompt('请输入新名称：', project.name);
                if (newName && newName !== project.name) {
                    await projectRef.update({
                        name: newName,
                        updatedAt: firebase.database.ServerValue.TIMESTAMP
                    });
                    alert('项目更新成功！');
                }
            } catch (error) {
                alert('编辑失败: ' + error.message);
            }
        }

        async function deleteProject(projectId) {
            if (!confirm('确定要永久删除这个项目吗？')) return;
            try {
                await db.ref(getUserPath(`projects/${projectId}`)).remove();
                alert('项目已删除');
            } catch (error) {
                alert('删除失败: ' + error.message);
            }
        }

        /*********************
         * 辅助功能
         *********************/
        function applyFilter() {
            currentFilter = document.getElementById('searchInput').value;
            currentPage = 1;
            renderProjects();
        }

        function resetFilter() {
            document.getElementById('searchInput').value = '';
            currentFilter = '';
            currentPage = 1;
            renderProjects();
        }

        function changePage(step) {
            currentPage = Math.max(1, currentPage + step);
            renderProjects();
        }

        // 手动同步Firebase数据
        async function syncFirebaseData() {
            const user = auth.currentUser;
            if (!user) {
                alert('请先登录');
                return;
            }

            try {
                // 显示加载提示
                const syncButton = document.querySelector('button[onclick="syncFirebaseData()"]');
                const originalText = syncButton.textContent;
                syncButton.textContent = '同步中...';
                syncButton.disabled = true;

                // 同步项目数据
                const projectsRef = db.ref(getUserPath('projects'));
                const projectsSnapshot = await projectsRef.once('value');
                const projectsData = projectsSnapshot.val() || {};
                
                // 同步每个项目的数据
                for (const projectId in projectsData) {
                    const projectRef = db.ref(getUserPath(`projects/${projectId}`));
                    
                    // 同步条目数据
                    const entriesRef = db.ref(getUserPath(`projects/${projectId}/entries`));
                    const entriesSnapshot = await entriesRef.once('value');
                    const entriesData = entriesSnapshot.val() || {};
                    
                    // 同步分类数据
                    const categoriesRef = db.ref(getUserPath(`projects/${projectId}/categories`));
                    const categoriesSnapshot = await categoriesRef.once('value');
                    const categoriesData = categoriesSnapshot.val() || { main: {} };
                    
                    // 同步日志数据
                    const logsRef = db.ref(getUserPath(`projects/${projectId}/logs`));
                    const logsSnapshot = await logsRef.once('value');
                    const logsData = logsSnapshot.val() || {};

                    // 更新项目最后同步时间
                    await projectRef.update({
                        lastSynced: firebase.database.ServerValue.TIMESTAMP
                    });
                }

                // 恢复按钮状态
                syncButton.textContent = originalText;
                syncButton.disabled = false;

                alert('数据同步完成！');
                loadProjects(); // 重新加载项目列表
            } catch (error) {
                console.error('同步失败:', error);
                alert('同步失败: ' + error.message);
                
                // 恢复按钮状态
                const syncButton = document.querySelector('button[onclick="syncFirebaseData()"]');
                syncButton.textContent = '同步数据';
                syncButton.disabled = false;
            }
        }

        // ======== 新增导航函数 ======== //
        function navigateToDatabase(projectId) {
            window.location.href = `database.html?project=${projectId}`;
        }
        // ============================ //
    </script>
</body>
</html>
